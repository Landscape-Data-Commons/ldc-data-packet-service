version: "3.3"
services:
  node:
    image: landscapedatacommons/dl_node:1.1
    build:
      context: .
      dockerfile: ./app/node.Dockerfile
    container_name: node
    volumes:
      # - ./app:/usr/src
      # comment out the shared if debugging
      # the creation of live files
      - shared:/usr/src/temp
    # env file for docker compose debug
    env_file:
      - ./app/db/.env
    # config for docker stack setup
    configs:
      - env_auth_audience
      - env_auth_domain
      - env_auth_id 
      - env_base
      - env_dbstr
      - env_mongopath
      - env_sendgrid
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        failure_action: rollback
        delay: 20s
      
      restart_policy:
        condition: on-failure
        delay: 5s
        window: 120s
    

  cron:
    image: landscapedatacommons/dl_cron:1.0
    build:
      context: .
      dockerfile: ./cron_container/cron.Dockerfile
    container_name: cron
    volumes:
      # uncomment to have packet production happen in shared docker volume
      - shared:/usr/src/temp
      # uncomment to have packet production happen locally
      # - ./app/temp:/usr/src/app/temp
    env_file:
      - .env
    
  nginx:
    image: landscapedatacommons/dl_nginx:1.0
    build:
      context: .
      dockerfile: ./nginx_container/nginx.Dockerfile
    container_name: nginx
    ports:
      - 5001:8081

  mongo:
    image: mongo:4.4.15
    restart: always
    container_name: mongo
    ports:
      - 27017:27017
    # env file for docker compose debug
    env_file:
      - .env
    volumes: 
      - mongodata:/data/db
    # config for docker stack setup
    configs:
     - env_mongoinit
     - env_mongopass
    

  mongo-express:
    image: mongo-express:1.0.0-alpha.4
    restart: always
    container_name: mongo-express
    volumes:
      - mongodb_config:/data/configdb
    env_file:
      - mexpress.env

    # config for docker stack setup
    configs:
     - env_mongoeexp_url
     - env_mongoexp_base
     - env_mongo_adm
    # env file for docker compose debug
    env_file:
      - .env
    
volumes:
  mongodata:
  mongodb_config:
  shared:

configs:
  env_auth_audience:
    external: true

  env_auth_domain:
    external: true
 
  env_auth_id:
    external: true
 
  env_base:
    external: true
  
  env_dbstr:
    external: true
 
  env_mongopath:
    external: true
 
  env_sendgrid:
    external: true

  env_mongoinit:
    external: true

  env_mongopass:
    external: true

  env_mongoeexp_url:
    external: true

  env_mongoexp_base:
    external: true

  env_mongo_adm:
    external: true
